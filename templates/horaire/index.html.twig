{% extends 'base.html.twig' %}

{% block breadcrumb %}

    <div class="row wrapper border-bottom white-bg page-heading">
        <div class="col-lg-10">
            <h1>Liste des horaires</h1>
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{{ path('home') }}">Accueil</a>
                </li>
                <li class="breadcrumb-item active">
                    <strong>Horaires</strong>
                </li>
            </ol>
        </div>
    </div>
{% endblock %}

{% block content %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.0.943/pdf.js"></script>
    <script src="{{ asset('js/pdfThumbnails.js') }}"></script>
    <div class="row">
        <div class="col-lg-3">

            <div class="ibox">
                <div class="ibox-content">
                    {% if user %}
                        <div class="btn-group">
                            <button data-toggle="modal" href="#modal-form" class="btn btn-white" type="button">
                                Visualiser
                            </button>
                            {{ include('horaire/modal.html.twig') }}
                            <button class="btn btn-white dropdown-toggle count-info" id="zoomOut" data-toggle="dropdown"
                                    type="button">Télécharger
                            </button>
                            <ul class="dropdown-menu dropdown-messages">
                                <li>
                                    <div class="dropdown-messages-box">
                                        <a href="{{ path('horaire_print', {'mois' : mois_numerique, 'annee': annee}) }}"><i
                                                    class="fas fa-file-excel"></i> Télécharger en XLSX</a>
                                    </div>
                                </li>
                                <li class="dropdown-divider"></li>
                                <li>
                                    <div class="dropdown-messages-box">
                                        <a href="{{ path('horaire_print_pdf', {'mois' : mois_numerique, 'annee': annee, 'userid':user.uid}) }}"><i
                                                    class="fas fa-file-pdf"></i> Télécharger un PDF</a>
                                    </div>
                                </li>
                                <li class="dropdown-divider"></li>
                                <li>
                                    <div class="dropdown-messages-box">
                                        <a href="#"><i class="far fa-file-pdf"></i> Télécharger tous les PDF</a>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    {% endif %}
                </div>
            </div>


            <div class="ibox">
                <div class="ibox-title">
                    <h5>Liste des collaborateurs : {{ nb_ouvriers }}</h5>
                </div>
                <div class="ibox-content">
                    <div class="align-center">
                        <input type="radio" name="enable" id="actif" checked value="1"> <label class="filter-actif"
                                                                                               for="actif">Actif</label>
                        <input type="radio" name="enable" id="inactif" value="0"> <label for="inactif">Inactif</label>
                    </div>
                    <div class="panel-body" id="nestable2">
                        <div class="panel-group" id="accordion">
                            {% for u in pager.currentPageResults %}
                                <div class="panel panel-default {{ u.etat == 1 ? 'uactif' : 'uinactif' }}"
                                     style="{{ u.etat == 0 ? 'display:none' : '' }}" data-id="{{ u.uid }}">
                                    <div class="panel-heading {{ u.uid == user.uid ? 'current' : '' }}">
                                            <h5 class="panel-title">
                                                <a href="{{ path('horaire_list_collaborator', {'id':u.uid}) }}"
                                                   class="{% for v in u.validations %}{% if v.mois == mois and v.annee == annee %}{{ v and v.isValide == true ? 'lock-user' : '' }}{% endif %}{% endfor %} no-drapp-a"
                                                   style="display: flex; position: relative">
                                                    {% if user.image is not empty %}
                                                        <div style="background-image: url('data:image/jpeg;base64,{{ u.image }}')"
                                                             class="rounded-circle">
                                                        </div>
                                                    {% endif %}
                                                    <span style="margin-left: 20px; margin-top: 10px;">
                                                        {{ u.lastname ~ " " ~ u.firstname }}
                                                    </span>
                                                </a>
                                            </h5>
                                        </div>
                                    
                                </div>
                            {% endfor %}
                        </div>

                        {% if pager.haveToPaginate %}
                            {{ pagerfanta(pager, 'my_template') }}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-9">
            <div class="ibox">
                <div class="ibox-content">
                    {{ include('horaire/filter.html.twig') }}
                </div>
            </div>
            <div class="ibox">
                <div class="ibox-title">
                    <h5>Horaires {% if user %}de {{ user ? user.lastname ~ ' ' ~ user.firstname : "??" }}
                            - {{ mois }} {{ annee }}{% endif %}</h5>
                    {% if user %}
                        <div class="ibox-tools">
                            <a href="{{ path('horaire_print', {'mois' : mois_numerique, 'annee' : annee}) }}">
                                <i class="fas fa-print"></i>
                                Imprimer
                            </a>
                            <a href="{{ path('horaire_add', {'id' : user.uid}) }}">
                                <i class="fa fa-plus"></i>
                                Ajouter
                            </a>
                        </div>
                    {% endif %}
                </div>
                <div class="ibox-content">
                    <div class="panel-body">
                        <div class="panel-group" id="accordion">
                            {% if user %}
                                <div class="table-responsive">
                                    <table class="table {{ validation and validation.isValide == true ? 'verouille' : '' }}"
                                           id="horaire_mois" data-nb_semaine="{{ horaires|length }}"
                                           data-heure_hebdo="{{ user.heureHebdo }}"
                                           data-total_semaine_prev="{{ total_heure }}"
                                           data-total_semaine_fictif_prev="{{ total_heure_fictif }}">
                                        <tr>
                                            <th></th>
                                            <th></th>
                                            <th>
                                                <a href="#" class="recuperation">
                                                    <img class="horaire-deplacer"
                                                         src="{{ asset('images/deplacer.png') }}"
                                                         alt=""></a>
                                            </th>
                                            <th></th>
                                            <th></th>
                                        </tr>
                                        <tr>
                                            <th>Jour</th>
                                            <th>Nb Heures</th>
                                            <th>TP</th>
                                            <th>Nb Heures Modifiées</th>
                                            <th>Chantiers</th>
                                            <th>Actions</th>
                                        </tr>
                                            {% set count = 0 %}
                                            {% set total = 0 %}
                                            {% set total_fictif = 0 %}
                                            {% set absence = 0 %}
                                            {% set absence_na = 0 %}
                                            {% set chomage_partiel = 0 %}
                                            {% set absence_fictive = 0 %}
                                            {% set absence_fictive_na = 0 %}
                                            {% set heure_normales = 0 %}
                                            {% set heure_normales_fictives = 0 %}
                                            {% set heure_supp = 0 %}
                                            {% set heure_supp_fictif = 0 %}
                                            {% set heure_supp_50 = 0 %}
                                            {% set heure_supp_fictif_50 = 0 %}
                                            {% set nb_jour_travaille = 0 %}
                                            {% set nb_jour_travaille_fictif = 0 %}
                                            {% set mois_precedent_compteur = 0 %}

                                            {% set conges = 0 %}
                                            {% set feries = 0 %}
                                            {% set ancien_jour = '' %}

                                            {% if horaires %}
                                            {% for num,horaire in horaires %}
                                                {% set total_semaine = 0 %}
                                                {% set total_pause_semaine = 0 %}
                                                {% set conges_semaine = 0 %}
                                                {% set feries_semaine = 0 %}
                                                {% set chomage_partiel_semaine = 0 %}
                                                {% set total_semaine_fictive = 0 %}
                                                {% set heure_normales_semaine = 0 %}
                                                {% set heure_normales_fictives_semaine = 0 %}
                                                {% set nb_heure_abs = 0 %}
                                                {% set nb_heure_abs_fictive = 0 %}
                                                {% set mois_precedent = false %}
                                                {% set heure_hebdo_semaine = user.heureHebdo %}
                                                {% set hn_feries = 0 %}
                                                {# On en veut pas plus de 5 jours dans le semaine #}
                                                {% set h_length = min(horaire|length, 5) %}
                                                {% set sum_abscence_autorise = 0 %}
                                                {% for j in horaire %}
                                                    {% set mois_precedent = j.mois_precedent %}
                                                    {% if mois_precedent == true and mois_precedent_compteur == 0 %}
                                                        {% set mois_precedent_compteur = 1 %}
                                                        <tr class="end-week">
                                                            <td colspan="5" style="text-align: center">
                                                                <h2>Mois précédent</h2>
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                    {% if j.heures is not empty %}
                                                        {% set nb_jour_travaille = j.time > 0 ? nb_jour_travaille  + 1 : nb_jour_travaille %}
                                                        {% if j.absence is not iterable %}
                                                            {% set nb_jour_travaille_fictif = j.fictif > 0 ? nb_jour_travaille_fictif  + 1 : nb_jour_travaille_fictif %}
                                                        {% endif %}
                                                        {% for h in j.heures %}
                                                            <tr data-nb_jour_{{ num + 1 }}="{{ h_length }}">
                                                                <td>
                                                                    {{ j.jour != ancien_jour ? j.jour | raw : '' }}
                                                                    {% set ancien_jour = j.jour %}
                                                                </td>
                                                                <td class="time_recuperation">



                                                                    {% if h.absence == 5 %}
                                                                        {# En formation #}
                                                                        {% set total_semaine_fictive = total_semaine_fictive + 7 %}
                                                                        {% if j.mois_precedent == false %}
                                                                            {% set conges_j = heure_hebdo_semaine / 5 %}
                                                                        {% endif %}
                                                                    {% endif %}

                                                                    {{ h.time > 0 ? h.time : '' }}
                                                                    {% set total_semaine = total_semaine + h.time %}
                                                                    {% if h.absence == 0 and h.fictif > 0 %}
                                                                        {# En poste #}
                                                                        {% set total_semaine_fictive = total_semaine_fictive + (h.fictif > 0 ? h.fictif : 0) %}

                                                                    {% elseif (h.absence == 1 ) and j.mois_precedent == false %}
                                                                        {# Congés payés #}
                                                                        {% set conges_semaine = conges_semaine + (heure_hebdo_semaine / 5) %}
                                                                        {% set conges_j = heure_hebdo_semaine / 5 %}
                                                                    {% elseif h.absence == 7 and j.mois_precedent == false %}
                                                                        {# Fériés #}
                                                                        {% set feries_semaine = feries_semaine + (heure_hebdo_semaine / 5) %}
                                                                        {% set feries_j = heure_hebdo_semaine / 5 %}
                                                                    {% elseif h.absence == 3 and j.mois_precedent == false %}
                                                                        {# Chomage partiel #}
                                                                        {% set chomage_partiel_semaine = 1 %}
                                                                    {% elseif (h.absence == 4 or (h.absence == 0 and h.fictif == 0)) and "samedi" not in j.jour %}
                                                                        {# Absence #}
                                                                        {% set nb_heure_abs_fictive = nb_heure_abs_fictive - (heure_hebdo_semaine / 5) %}
                                                                    {% endif %}

                                                                    {% if h.time == 0 and "samedi" not in j.jour %}
                                                                        {% set nb_heure_abs = nb_heure_abs - (heure_hebdo_semaine / 5) %}
                                                                    {% endif %}
                                                                </td>
                                                                <td>
                                                                    {% set total_pause_semaine = total_pause_semaine + j.pause %} 
                                                                    {{j.pause}}
                                                                </td>
                                                                <td>
                                                                    {% set vfictif = '' %}
                                                                    {% if feries_j is defined %}
                                                                        {% set vfictif = feries_j|number_format(2) %}
                                                                        {% set sum_abscence_autorise = sum_abscence_autorise + (vfictif)|number_format(2, '.', '') %}
                                                                    {% elseif conges_j is defined %}
                                                                        {% set vfictif = conges_j|number_format(2) %}
                                                                        {% set sum_abscence_autorise = sum_abscence_autorise + (vfictif)|number_format(2, '.', '') %}
                                                                    {% elseif h.fictif > 0 %}
                                                                        {% set vfictif = h.fictif %}
                                                                    {% endif %}
                                                                    <input type="text" data-semaine="{{ num + 1 }}"
                                                                           data-id="{{ h.id }}"
                                                                           class="fictif {{ j.mois_precedent ? 'mois_precedent': '' }}"
                                                                           value="{{ vfictif }}"
                                                                           style="width: 75px" {{ h.absence > 0 ? 'readonly=true' : '' }}>
                                                                    - <select name="absence"
                                                                              class="absence {{ j.mois_precedent ? 'mois_precedent': '' }}"
                                                                              data-user="{{ user.uid }}"
                                                                              data-date="{{ j.jour_numerique }}"
                                                                              data-id="{{ h.id }}">
                                                                        <option {{ h.absence == 0 ? 'selected' : '' }}
                                                                                value="0">En Poste
                                                                        </option>
                                                                        <option {{ h.absence == 1 ? 'selected' : '' }}
                                                                                value="1">Congés Payés
                                                                        </option>
                                                                        <option {{ h.absence == 2 ? 'selected' : '' }}
                                                                                value="2">En arrêt
                                                                        </option>
                                                                        <option {{ h.absence == 3 ? 'selected' : '' }}
                                                                                value="3">Chômage Partiel
                                                                        </option>
                                                                        <option {{ h.absence == 4 ? 'selected' : '' }}
                                                                                value="4">Absence
                                                                        </option>
                                                                        <option {{ h.absence == 5 ? 'selected' : '' }}
                                                                                value="5">Formation
                                                                        </option>
                                                                        <option {{ h.absence == 6 ? 'selected' : '' }}
                                                                                value="6">RTT
                                                                        </option>
                                                                        <option {{ h.absence == 7 ? 'selected' : '' }}
                                                                                value="7">Férié
                                                                        </option>
                                                                    </select>
                                                                </td>
                                                                <td>
                                                                    {{ h.chantier ? h.chantier.nameentreprise : '' }}
                                                                </td>
                                                                <td>
                                                                    <a href="{{ path('horaire_edit', {'horaire':h.id}) }}"><i
                                                                                class="far fa-edit {{ j.mois_precedent ? 'dnone': '' }}"></i></a>
                                                                    <a onclick="return confirm('Etes-vous sur de vouloir supprimer cet horaire ?')"
                                                                       href="{{ path('horaire_delete', {'horaire':h.id}) }}"><i
                                                                                class="fas fa-trash-alt {{ j.mois_precedent ? 'dnone': '' }}"></i></a>
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    {% else %}
                                                        {% set nb_heure_abs_fictive = nb_heure_abs_fictive - (heure_hebdo_semaine / 5) %}
                                                        {% set nb_heure_abs = nb_heure_abs - (heure_hebdo_semaine / 5) %}
                                                        <tr data-nb_jour_{{ num }}="{{ h_length }}">
                                                            <td>
                                                                {{ j.jour | raw }}
                                                            </td>
                                                            <td>
                                                                &nbsp;
                                                            </td>
                                                            <td></td>
                                                            <td>
                                                                <input type="text" data-user="{{ user.uid }}"
                                                                       data-date="{{ j.jour_numerique }}"
                                                                       data-semaine="{{ num + 1 }}"
                                                                       class="fictif-without-id {{ j.mois_precedent ? 'mois_precedent': '' }}"
                                                                       value=""
                                                                       style="width: 75px">
                                                                - <select name="absence"
                                                                          class="absence {{ j.mois_precedent ? 'mois_precedent': '' }}"
                                                                          data-user="{{ user.uid }}"
                                                                          data-date="{{ j.jour_numerique }}"
                                                                          data-id="0">
                                                                    <option value="0">En Poste</option>
                                                                    <option value="1">Congés Payés</option>
                                                                    <option value="2">En arrêt</option>
                                                                    <option value="3">Chômage Partiel</option>
                                                                    <option value="4">Absence</option>
                                                                    <option value="5">Formation</option>
                                                                    <option value="6">RTT</option>
                                                                    <option value="7">Férié</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                &nbsp;
                                                            </td>
                                                            <td>
                                                                <a href="{{ path('horaire_add_from_date', {'id' : user.uid, 'timestamp': j.timestamp}) }}">
                                                                    <i class="fa fa-plus {{ j.mois_precedent ? 'dnone': '' }}"></i>
                                                                </a>
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                {% endfor %}
                                                {% if mois_precedent == false %}
                                                    <tr>
                                                        <td class="total-h">
                                                            Total
                                                        </td>
                                                        <td>
                                                            {% set total = total + total_semaine %}
                                                            {{ total_semaine }}
                                                        </td>
                                                        <td>
                                                            {{total_pause_semaine}}
                                                        </td>
                                                        <td colspan="3" class="total_semaine_{{ num + 1 }}">
                                                            {% set total_fictif = total_fictif + total_semaine_fictive %}
                                                            {{ total_semaine_fictive }}
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="total-h">
                                                            HEURES SUPPLEMENTAIRES à 25%
                                                        </td>
                                                        <td>
                                                            {% set hs_semaine = total_semaine + (total_heure > 0 and count == 0 ? total_heure : 0) - user.heureHebdo > 0 ? (total_semaine + (total_heure > 0 and count == 0 ? total_heure : 0) - user.heureHebdo <= 8 ? total_semaine + (total_heure > 0 and count == 0 ? total_heure : 0) - user.heureHebdo : 8) : 0 %}
                                                            {% set hs_semaine_50 = total_semaine + (total_heure > 0 and count == 0 ? total_heure : 0) - user.heureHebdo > 0 ? (total_semaine + (total_heure > 0 and count == 0 ? total_heure : 0) - user.heureHebdo > 8 ? total_semaine + (total_heure > 0 and count == 0 ? total_heure : 0) - user.heureHebdo - 8 : 0) : 0 %}
                                                            {% set heure_supp = heure_supp + hs_semaine %}
                                                            {% set heure_supp_50 = heure_supp_50 + hs_semaine_50 %}
                                                            {{ hs_semaine }}
                                                        </td>
                                                        <td>.</td>
                                                        <td colspan="3" class="hs_semaine_{{ num + 1 }}">
                                                            {% if feries_semaine == 0 %}
                                                                {% set hs_semaine_fictif = total_semaine_fictive + (total_heure_fictif > 0 and count == 0 ? total_heure_fictif : 0) - user.heureHebdo > 0 ? (total_semaine_fictive + (total_heure_fictif > 0 and count == 0 ? total_heure_fictif : 0) - user.heureHebdo <= 8 ? total_semaine_fictive + (total_heure_fictif > 0 and count == 0 ? total_heure_fictif : 0) - user.heureHebdo : 8) : 0 %}
                                                                {% set hs_semaine_fictif_50 = total_semaine_fictive + (total_heure_fictif > 0 and count == 0 ? total_heure_fictif : 0) - user.heureHebdo > 0 ? (total_semaine_fictive + (total_heure_fictif > 0 and count == 0 ? total_heure_fictif : 0) - user.heureHebdo > 8 ? total_semaine_fictive + (total_heure_fictif > 0 and count == 0 ? total_heure_fictif : 0) - user.heureHebdo - 8 : 0) : 0 %}
                                                                {% set heure_supp_fictif = heure_supp_fictif + hs_semaine_fictif %}
                                                                {% set heure_supp_fictif_50 = heure_supp_fictif_50 + hs_semaine_fictif_50 %}
                                                                {{ hs_semaine_fictif }}
                                                            {% else  %}
                                                                0
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% if hs_semaine_50 > 0 or (hs_semaine_fictif_50 is defined and hs_semaine_fictif_50 > 0) %}
                                                        <tr>
                                                            <td class="total-h">
                                                                HEURES SUPPLEMENTAIRES à 50%
                                                            </td>
                                                            <td>
                                                                {{ hs_semaine_50 }}
                                                            </td>
                                                            <td>.</td>
                                                            <td colspan="3" class="hs_semaine_fictif_50_{{ num + 1 }}">
                                                                {{ hs_semaine_fictif_50 is defined ? hs_semaine_fictif_50 : 0  }}
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                    {% if chomage_partiel_semaine == 1 and ((heure_hebdo_semaine - total_semaine_fictive - feries_semaine) > 0) %}
                                                        <tr>
                                                            <td class="total-h">
                                                                Chomâge partiel
                                                            </td>
                                                            <td></td>
                                                            <td>.</td>
                                                            <td colspan="3" class="chomage_{{ num + 1 }}">
                                                                {% set chomage_partiel_semaine = (heure_hebdo_semaine - total_semaine_fictive - feries_semaine) %}
                                                                {% set chomage_partiel = chomage_partiel + chomage_partiel_semaine %}
                                                                {{ chomage_partiel_semaine }}
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                    <tr>
                                                        <td class="total-h">
                                                            ABSENCES Non Autorisées
                                                        </td>
                                                        <td>
                                                            {% set total_heure_mois_prec = (total_heure > 0 and count == 0 ? total_heure : 0) %}
                                                            {% set nombre_heure_semaine_protata =  ((user.heureHebdo / 5)*(h_length)) %}
                                                            {% set abs_semaine = total_semaine + total_heure_mois_prec - nombre_heure_semaine_protata < 0 ? total_semaine + total_heure_mois_prec - nombre_heure_semaine_protata : 0 %}
                                                            {% set absence_na = absence_na + abs_semaine %}

                                                            {% set abs_semaine = abs_semaine + conges_semaine + feries_semaine %}
                                                            {{ (total_semaine + conges_semaine + feries_semaine) < 35 ? abs_semaine : 0 }}
                                                        </td>
                                                        <td>.</td>
                                                        <td colspan="3" class="abs_semaine_na_{{ num + 1 }}">
                                                            {% set total_heure_fictive_mois_prec = (total_heure_fictif > 0 and count == 0 ? total_heure_fictif : 0) %}
                                                            {% set abs_semaine_fictive =  total_semaine_fictive + total_heure_fictive_mois_prec - nombre_heure_semaine_protata + conges_semaine + chomage_partiel_semaine + feries_semaine < 0 ? total_semaine_fictive + total_heure_fictive_mois_prec - nombre_heure_semaine_protata + conges_semaine + chomage_partiel_semaine + feries_semaine :  0 %}
                                                            {% set absence_fictive_na = absence_fictive_na + abs_semaine_fictive %}
                                                            {{ abs_semaine_fictive }}
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="total-h">
                                                            ABSENCES Autorisées
                                                        </td>
                                                        <td class="abs_semaine_{{ num + 1 }}">
                                                            {#{% set absence = absence + nb_heure_abs %}
                                                            {{ abs_semaine > 0 ? nb_heure_abs : 0 }}#}
                                                            {% set absence_fictive = absence_fictive + nb_heure_abs_fictive %}
                                                            {{ abs_semaine_fictive >= 0 ? nb_heure_abs_fictive : 0 }}
                                                        </td>
                                                        <td>.</td>
                                                        <td colspan="3" class="abs_semaine_{{ num + 1 }}">
                                                            {{ abs_semaine_fictive >= 0 ? nb_heure_abs_fictive : 0 }}
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="total-h">
                                                            Heures normales
                                                        </td>
                                                        <td>
                                                            {% set heure_normales_semaine = abs_semaine >= 0 ? nb_heure_abs|abs : 0 %}
                                                            {% set heure_normales = heure_normales + heure_normales_semaine %}
                                                            {{ heure_normales_semaine }}
                                                        </td>
                                                        <td>.</td>
                                                        <td colspan="3" class="heures_normales_{{ num + 1 }}">
                                                            {% if feries_semaine > 0  %}
                                                                {% set hn_feries = total_semaine_fictive + (total_heure > 0 and count == 0 ? total_heure : 0) - user.heureHebdo > 0 ? total_semaine_fictive + (total_heure > 0 and count == 0 ? total_heure : 0) - user.heureHebdo : 0 %}
                                                            {% endif %}
                                                            {% set heure_normales_fictives_semaine = abs_semaine_fictive >= 0 ? nb_heure_abs_fictive|abs + hn_feries : 0 %}
                                                            {% set heure_normales_fictives = heure_normales_fictives + heure_normales_fictives_semaine %}
                                                            {{ heure_normales_fictives_semaine }}
                                                        </td>
                                                    </tr>
                                                    {% if conges_semaine > 0 %}
                                                        <tr>
                                                            <td class="total-h">
                                                                Congés Payés
                                                            </td>
                                                            <td class="conges_{{ num + 1 }}">
                                                                {% set conges = conges + conges_semaine %}
                                                                {{ conges_semaine }}
                                                            </td>
                                                            <td>.</td>
                                                            <td colspan="3" class="conges_{{ num + 1 }}">
                                                                {{ conges_semaine }}
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                    {% if feries_semaine > 0 %}
                                                        <tr>
                                                            <td class="total-h">
                                                                Fériés
                                                            </td>
                                                            <td class="feries_{{ num + 1 }}">
                                                                {% set feries = feries + feries_semaine %}
                                                                {{ feries_semaine }}
                                                            </td>
                                                            <td>.</td>
                                                            <td colspan="3" class="feries_{{ num + 1 }}">
                                                                {{ feries_semaine }}
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                    <tr class="end-week end-week_{{ num + 1 }}">
                                                        <td colspan="5">

                                                        </td>
                                                    </tr>

                                                    {% set count = 1 %}
                                                {% else %}
                                                    <tr class="end-week">
                                                        <td colspan="5" style="text-align: center">
                                                            <h2>Mois en cours</h2>
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td>Aucun horaire renseigné</td>
                                            </tr>
                                        {% endif %}
                                        <tr style="background-color: #f5f5f5;">
                                            <td class="total-h">
                                                TOTAL GENERAL HEURES
                                            </td>
                                            <td class="total_general">
                                                {{ total }}
                                            </td>
                                            <td>.</td>
                                            <td class="total_mois">
                                                {{ total_fictif }}
                                            </td>
                                            <td colspan="2" class="total_mois_du">
                                                {% if total - total_fictif > 0 %} je dois {% elseif total - total_fictif < 0 %} Me dois {% endif %}
                                                {{ (total - total_fictif)|abs }}
                                            </td>
                                        </tr>
                                        <tr style="background-color: #f5f5f5;">
                                            <td class="total-h">
                                                TOTAL HEURES SUP à 25%
                                            </td>
                                            <td>
                                                {{ heure_supp }}
                                            </td>
                                            <td>.</td>
                                            <td colspan="3" class="hs_mois">
                                                {{ heure_supp_fictif }}
                                            </td>
                                        </tr>
                                        {% if heure_supp_50 > 0 or heure_supp_fictif_50 > 0 %}
                                            <tr style="background-color: #f5f5f5;">
                                                <td class="total-h">
                                                    TOTAL HEURES SUP à 50%
                                                </td>
                                                <td>
                                                    {{ heure_supp_50 }}
                                                </td>
                                                <td>.</td>
                                                <td colspan="3" class="hs_mois_50">
                                                    {{ heure_supp_fictif_50 }}
                                                </td>
                                            </tr>
                                        {% endif %}
                                        <tr style="background-color: #f5f5f5;">
                                            <td class="total-h">
                                                TOTAL ABSENCES Non Autorisés
                                            </td>
                                            <td>
                                                {{ absence_na }}
                                            </td>
                                            <td>.</td>
                                            <td colspan="3" class="absence_mois">
                                                {{ absence_fictive_na }}
                                            </td>
                                        </tr>
                                        <tr style="background-color: #f5f5f5;">
                                            <td class="total-h">
                                                TOTAL ABSENCES Autorisés
                                            </td>
                                            <td>
                                                {{ absence }}
                                            </td>
                                            <td>.</td>
                                            <td colspan="3" class="absence_mois">
                                                {{ absence_fictive }}
                                            </td>
                                        </tr>
                                        <tr style="background-color: #f5f5f5;">
                                            <td class="total-h">
                                                TOTAL HEURES NORMALES
                                            </td>
                                            <td class="heure_normale_mois">
                                                {#{{ heure_normales }}#}
                                                {{ heure_normales_fictives }}
                                            </td>
                                            <td>.</td>
                                            <td colspan="3" class="heure_normale_mois">
                                                {{ heure_normales_fictives }}
                                            </td>
                                        </tr>
                                        {% if conges %}
                                            <tr style="background-color: #f5f5f5;">
                                                <td class="total-h">
                                                    TOTAL Congés Payés
                                                </td>
                                                <td></td>
                                                <td>.</td>
                                                <td colspan="3" class="conges">
                                                    {{ conges }}
                                                </td>
                                            </tr>
                                        {% endif %}
                                        {% if feries %}
                                            <tr style="background-color: #f5f5f5;">
                                                <td class="total-h">
                                                    TOTAL Fériés
                                                </td>
                                                <td></td>
                                                <td>.</td>
                                                <td colspan="3" class="feries">
                                                    {{ feries }}
                                                </td>
                                            </tr>
                                        {% endif %}
                                        {% if  chomage_partiel %}
                                            <tr style="background-color: #f5f5f5;">
                                                <td class="total-h">
                                                    TOTAL Chomâge partiel
                                                </td>
                                                <td></td>
                                                <td>.</td>
                                                <td colspan="3" class="chomage">
                                                    {{ chomage_partiel }}
                                                </td>
                                            </tr>
                                        {% endif %}
                                        <tr style="background-color: #f5f5f5;" class="fin-table">
                                            <td colspan="6">
                                                <br>
                                                <br>
                                            </td>
                                        </tr>
                                        <tr style="background-color: #f5f5f5;">
                                            <td class="total-h">
                                                Prime
                                            </td>
                                            <td></td>
                                            <td>.</td>
                                            <td colspan="4">
                                                <input value="{{ prime is not null ? prime.prime : '' }}"
                                                       style="width: 50px;" type="text" name="prime" id="prime">
                                            </td>
                                        </tr>
                                        <tr style="background-color: #f5f5f5;">
                                            <td class="total-h">
                                                Nombre de jour travaillé
                                            </td>
                                            <td>
                                                {{ nb_jour_travaille - count_jour_precedent }}
                                            </td>
                                            <td>.</td>
                                            <td colspan="3" class="trajet-f">
                                                {{ nb_jour_travaille_fictif - count_jour_precedent }}
                                            </td>
                                        </tr>
                                        <tr style="background-color: #f5f5f5;">
                                            <td class="total-h">
                                                Panier
                                            </td>
                                            <td>
                                                {% if user.panier == 1 %}
                                                    {{ nb_jour_travaille  - count_jour_precedent }}
                                                {% endif %}
                                            </td>
                                            <td>.</td>
                                            <td colspan="3" class="panier-f">
                                                {% if user.panier == 1 %}
                                                    {{ nb_jour_travaille_fictif - count_jour_precedent }}
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr style="background-color: #f5f5f5;">
                                            <td class="total-h">
                                                Nombre de trajets
                                            </td>
                                            <td>
                                                {% if user.trajet == 1 %}
                                                    {{ nb_jour_travaille - count_jour_precedent }}
                                                {% endif %}
                                            </td>
                                            <td>.</td>
                                            <td colspan="3" class="trajet-f">
                                                {% if user.trajet == 1 %}
                                                    {{ nb_jour_travaille_fictif - count_jour_precedent }}
                                                {% endif %}
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                                <div>
                                    <!-- Modal -->
                                    <div class="modal fade" id="docModal" tabindex="-1" role="dialog" aria-labelledby="docModalLabel">
                                        <div class="modal-dialog  modal-lg" role="document">
                                            <div class="modal-content">
                                                <iframe id="docModalIframe" src="" style="width:100%; height:500px;display: none;" frameborder="0"></iframe>
                                            </div>
                                        </div>
                                    </div>

                                    <br>
                                    Salaire de Base: 151,67 X {{ user.tauxHoraire }} = {{ (151.67 * user.tauxHoraire) | round(2) }}
                                    <br>
                                    Heures supplémentaires à 25 % : {{ heure_supp_fictif }} X {{ (user.tauxHoraire*1.25) | round(4) }} = {{ (heure_supp_fictif * (user.tauxHoraire*1.25)) | round(2) }}
                                    <br>
                                    Heures supplémentaires à 50 % : {{ heure_supp_fictif_50 }} X {{ (user.tauxHoraire*1.50) | round(4) }} = {{ (heure_supp_fictif_50 * (user.tauxHoraire*1.50)) | round(2) }}
                                    <br><br>
                                    <label for="cout_global">Coût global</label>
                                    <input type="number" disabled class="form-control" id="cout_global"
                                              data-user="{{ user.uid }}"
                                              data-mois="{{ mois }}" data-annee="{{ annee }}" value="{{ paie.coutGlobal is defined ? paie.coutGlobal : ''}}">
                                    <br><br>
                                    <h5>Fiches de paie</h5>
                                    <div>
                                        {% if paie.document_file is defined %}
                                            {% if paie.documentFile|slice(-3,3)|lower == "pdf" %}
                                                <object class="pdfupload" data="/uploads/paies/{{paie.documentFile}}" type="application/pdf" width="100%" height="980px"></object>
                                                {% else %}
                                                <img src="/uploads/paies/{{paie.documentFile}}" alt="fichier facture uploadé" width="100%">
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">-- AUCUNE FICHE DE PAIE ASSOCIEE --</span>
                                        {% endif %}
                                    </div>
                                    {#<form id="fileform" enctype="multipart/form-data" method="post">
                                        <div class="input-group">
                                          <span class="input-group-addon" id="filelabel"><i class="fas fa-file-pdf"></i></span>
                                          <input type="hidden" name="uid" value="{{ user.uid }}">
                                          <input type="file" id="fichier" name="fichier" required="required" class="form-control" aria-describedby="filelabel">
                                        </div>
                                    </form>#}
                                    <br><br>
                                    <label for="observation">Observations</label>
                                    <textarea class="form-control" name="observation" id="observation"
                                              data-user="{{ user.uid }}"
                                              data-mois="{{ mois }}" data-annee="{{ annee }}" cols="30"
                                              rows="10">{{ observation ? observation.observation : '' }}</textarea>
                                </div>
                                <div>
                                    <br>
                                    <br>
                                    {% if validation and validation.isValide == true %}
                                        <a class="btn btn-primary"
                                           href="{{ path('horaire_validation', {'mois' : mois, 'annee':annee, 'userid' :user.uid}) }}">Dévérouiller
                                            la fiche</a>
                                    {% else %}
                                        <a class="btn btn-primary"
                                           href="{{ path('horaire_validation', {'mois' : mois, 'annee':annee, 'userid' :user.uid}) }}">Valider
                                            la fiche</a>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block javascript %}
{% if user %}
$(function () {
    if ($('.verouille').length > 0) {
        $('.verouille input,.verouille  select').attr('disabled', 'disabled');
    }

    if ($('.mois_precedent').length > 0) {
        $('.mois_precedent').attr('disabled', 'disabled');
        $('.mois_precedent').parent().parent().css('background-color', '#f3f3f4');
    }

    function recalcul() {
        var nb_semaine = $('table#horaire_mois').attr('data-nb_semaine');
        var nb_heure_prev = parseFloat($('table#horaire_mois').attr('data-total_semaine_fictif_prev'));
        var total_m = 0;
        var hs_m = 0;
        var hs_50_m = 0;
        var abs_m = 0;
        var abs_na_m = 0;
        var conges_m = 0;
        var feries_m = 0;
        var chomage_m = 0;
        var heure_normale_m = 0;
        var count = 0;
        var ancien_mois = 0;
        for (i = 1; i <= nb_semaine; i++) {
            var total = 0;
            var hs = 0;
            var hs_50 = 0;
            var hn_feries = 0;
            var abs = 0;
            var nb_heure_abs = 0;
            var heure_normale = 0;
            var conges = 0;
            var formation = 0;
            var feries = 0;
            var chomage = 0;

            // Si semaine du mois precedent, on zap
            if (i == 1 && $('input[data-semaine="1"]').first().hasClass('mois_precedent')) {
                continue;
            }
            $('input[data-semaine="' + i + '"]').each(function () {
                var montant = parseFloat($(this).val());
                var a = $(this).next().val();

                if (a == 5) {
                    // En formation
                    total += 7;
                }
                else if (a == 1) {
                    // Congés payés
                    conges = conges + (parseFloat($('table#horaire_mois').attr('data-heure_hebdo')) / 5);
                }
                 else if (a == 7) {
                    // Fériés
                    feries = feries + (parseFloat($('table#horaire_mois').attr('data-heure_hebdo')) / 5);
                } else if (a == 3) {
                    // Chomage partiel
                    chomage = 1;
                } else if (!isNaN(montant) && montant > 0 && a == 0) {
                    total = total + montant;
                } else if (a == 4 || (a == 0 && (montant == 0 || isNaN(montant)))) {
                    nb_heure_abs = nb_heure_abs - (parseFloat($('table#horaire_mois').attr('data-heure_hebdo')) / 5);
                }

            });
            // Total Semaine
            $('.total_semaine_' + i).text(total);
            total_m = total_m + total;
            if(nb_heure_prev > 0 && count === 0) {
                ancien_mois = nb_heure_prev;
                count = 1;
            } else {
                ancien_mois = 0;
            }
            console.log(ancien_mois);
            count++;
            // HS Semaine
            if (total + ancien_mois - parseFloat($('table#horaire_mois').attr('data-heure_hebdo')) > 0 && feries == 0) {
                hs = total + ancien_mois - parseFloat($('table#horaire_mois').attr('data-heure_hebdo'));
                if (hs >= 8) {
                    hs_50 = hs - 8;
                    hs = 8;
                    if ($('.hs_semaine_fictif_50_' + i).length == 0) {
                        var str = '<tr> <td class="total-h">  HEURES SUPPLEMENTAIRES &agrave; 50% </td> <td> 0 </td> <td colspan="3" class="hs_semaine_fictif_50_' + i + '">0</td> </tr>';
                        $(str).insertAfter($('.hs_semaine_' + i).parent());
                    }
                }
                hs_m = hs_m + hs;
                hs_50_m = hs_50_m + hs_50;
            } else {
                hs = 0;
            }
            $('.hs_semaine_' + i).text(hs);
            $('.hs_semaine_fictif_50_' + i).text(hs_50);
            // Congés
            if (conges > 0) {
                if ($('.conges_' + i).length == 0) {
                    var str = '<tr> <td class="total-h">  Congés payés </td> <td> 0 </td> <td colspan="3" class="conges_' + i + '">0</td> </tr>';
                    $(str).insertAfter($('.abs_semaine_' + i).parent());
                }
                conges_m = conges_m + conges;
            } else {
                conges = 0;
            }
            $('.conges_' + i).text(conges);
            // Fériés
            if (feries > 0) {
                if ($('.feries_' + i).length == 0) {
                    var str = '<tr> <td class="total-h">  Fériés </td> <td> 0 </td> <td colspan="3" class="feries_' + i + '">0</td> </tr>';
                    $(str).insertBefore($('.end-week_' + i));
                }
                feries_m = feries_m + feries;
            } else {
                feries = 0;
            }
            $('.feries_' + i).text(feries);
            // Chomage
            if (chomage > 0) {
                if ($('.chomage_' + i).length == 0) {
                    var str = '<tr> <td class="total-h">  Chomâge Partiel </td> <td> 0 </td> <td colspan="3" class="chomage_' + i + '">0</td> </tr>';
                    $(str).insertBefore($('.end-week_' + i));
                }
                chomage = ((parseFloat($('table#horaire_mois').attr('data-heure_hebdo')) - total - feries) > 0) ? (parseFloat($('table#horaire_mois').attr('data-heure_hebdo')) - total - feries) : 0;
                chomage_m = chomage_m + chomage;
            } else {
                chomage = 0;
            }
            $('.chomage_' + i).text(chomage);

            // Absences Non autorisées
            if(chomage == 0) {
                if (total + ancien_mois + conges + feries - ((parseFloat($('table#horaire_mois').attr('data-heure_hebdo')) / 5) * parseFloat($('tr[data-nb_jour_' + i + ']').attr('data-nb_jour_' + i))) < 0) {
                    abs = total + ancien_mois + conges + feries - ((parseFloat($('table#horaire_mois').attr('data-heure_hebdo')) / 5) * parseFloat($('tr[data-nb_jour_' + i + ']').attr('data-nb_jour_' + i)));
                    abs_na_m = abs_na_m + abs;
                } else {
                    abs = 0;
                }
            }
            $('.abs_semaine_na_' + i).text(abs);
            $('.abs_semaine_' + i).text( abs >= 0 ? nb_heure_abs : 0);

            // Absences autorisées
            abs_m = abs_m + nb_heure_abs;

            // Heures normales
            if(feries > 0 && total + ancien_mois - parseFloat($('table#horaire_mois').attr('data-heure_hebdo')) > 0) {
                hn_feries = total + ancien_mois - parseFloat($('table#horaire_mois').attr('data-heure_hebdo'));
            }
            heure_normale = abs >= 0 ? Math.abs(nb_heure_abs) + hn_feries : 0;
            heure_normale_m =  heure_normale_m + heure_normale;
            $('.heures_normales_' + i).text(heure_normale);

        }
        // TOTAUX
        $('.absence_mois').text(abs_m);
        $('.heure_normale_mois').text(heure_normale_m);
        $('.total_mois').text(total_m);

        $total_mois_du = "";
        if(parseFloat($('.total_general').text()) - parseFloat($('.total_mois').text()) > 0){
            $total_mois_du += "je dois ";
        }
        else{
            $total_mois_du += "Me dois ";
        }

        $total_mois_du += Math.abs(parseFloat($('.total_general').text()) - parseFloat($('.total_mois').text()));
        $('.total_mois_du').text($total_mois_du);

        $('.hs_mois').text(hs_m);
        if (hs_50_m > 0) {
            if ($('.hs_mois_50').length == 0) {
                $(' <tr style="background-color: #f5f5f5;"> <td class="total-h"> TOTAL HEURES SUP &agrave; 50% </td><td>0</td><td colspan="3" class="hs_mois_50">0</td></tr>').insertAfter($('.hs_mois').parent());
            }
            $('.hs_mois_50').text(hs_50_m);
        } else {
            $('.hs_mois_50').parent().remove()
        }


        // Total congés
        if (conges_m > 0) {
            if ($('.conges').length == 0) {
                $(' <tr style="background-color: #f5f5f5;"> <td class="total-h"> TOTAL Congés Payés </td><td>0</td><td colspan="3" class="conges">0</td></tr>').insertAfter($('.absence_mois').parent());
            }
            $('.conges').text(conges_m);
        } else {
            $('.conges').parent().remove()
        }

        // Total fériés
        if (feries_m > 0) {
            if ($('.feries').length == 0) {
                $(' <tr style="background-color: #f5f5f5;"> <td class="total-h"> TOTAL Fériés </td><td>0</td><td colspan="3" class="feries">0</td></tr>').insertBefore($('.fin-table'));
            }
            $('.feries').text(feries_m);
        } else {
            $('.feries').parent().remove()
        }

        // Total chomage partiel
        if (chomage_m > 0) {
            if ($('.chomage').length == 0) {
                $(' <tr style="background-color: #f5f5f5;"> <td class="total-h"> TOTAL Chomâge Partiel </td><td>0</td><td colspan="3" class="chomage">0</td></tr>').insertBefore($('.fin-table'));
            }
            $('.chomage').text(chomage_m);
        } else {
            $('.chomage').parent().remove()
        }

        // NB Jours travaillés
        var nb_j_t = 0;
        $('.fictif').each(function () {
            if (parseFloat($(this).val()) > 0 && $(this).next().val() == 0) {
                nb_j_t = nb_j_t + 1;
            }
        });
        $('.fictif-without-id').each(function () {
            if (parseFloat($(this).val()) > 0 && $(this).next().val() == 0) {
                nb_j_t = nb_j_t + 1;
            }
        });

        $count_jour_precedent = parseInt("{{count_jour_precedent}}");
        $('.trajet-f').text(nb_j_t - $count_jour_precedent);
        $('.panier-f').text(nb_j_t - $count_jour_precedent);
    }

    $('input[name="enable"]').change(function () {
        if ($(this).val() == 0) {
            $('.uactif').css('display', 'none');
            $('.uinactif').css('display', 'block');
        } else {
            $('.uactif').css('display', 'block');
            $('.uinactif').css('display', 'none');
        }
    });

    $('.recuperation').click(function (e) {
        e.preventDefault();
        $('.time_recuperation').each(function (i) {
            recup = parseFloat($(this).text());
            $(this).next().find('input:not(.mois_precedent)').val(recup).change();
        });
    });

    $('.absence').change(function (e) {
        e.preventDefault();
        $(this).parent().css('background-color', '#dce6ed');
        if ($(this).val() == 0) {
            $(this).prev().attr('readonly', false);
        } else if ($(this).val() == 1 || $(this).val() == 5) {
            $(this).prev().attr('readonly', true);
            $(this).prev().val(parseFloat($('table#horaire_mois').attr('data-heure_hebdo')) / 5);
        } else {
            $(this).prev().attr('readonly', true);
            $(this).prev().val('');
        }
        $.ajax({
            type: "POST",
            url: "{{ path('horaire_absence') }}",
            data: {
                user: $(this).attr('data-user'),
                date: $(this).attr('data-date'),
                absence: $(this).val(),
                id: $(this).attr('data-id'),
            },
        });
        recalcul();
    });


    $('#observation').change(function () {
        $.ajax({
            type: "POST",
            url: "{{ path('horaire_observation', {'uid':user.uid, 'mois':mois, 'annee':annee}) }}",
            data: {observation: $("#observation").val()}
        });
    });
    $('#cout_global').change(function () {
        $.ajax({
            type: "POST",
            url: "{{ path('horaire_observation', {'uid':user.uid, 'mois':mois, 'annee':annee}) }}",
            data: {cout_global: $("#cout_global").val()}
        });
    });

    $('#fichier').change(function () {
        var fd = new FormData($("#fileform")[0]);
        $.ajax({
            url: "{{ path('horaire_file_galerie') }}",  
            type: 'POST',
            data: fd,
            cache: false,
            contentType: false,
            processData: false,
            success: function(response){
                if(response.success){
                    $('#table-docs').html(response.docs);
                }
            }
        });
    });

    $(document).on('click','.view-doc', function(e){
        e.preventDefault();
        url = $(this).attr('href');
        $('#docModalIframe').attr('src',url);
        $('#docModalIframe').show();
        $('#docModal').modal('show');
    });

    $(document).on('click','.delete-doc',function(e){
        e.preventDefault();
        url = $(this).attr('href');
        $.ajax({
            url: url,  
            type: 'POST',
            data: {},
            cache: false,
            contentType: false,
            processData: false,
            success: function(response){
                if(response.success){
                    $('#table-docs').html(response.docs);
                }
            }
        });
    });


    $('#prime').change(function () {
        $.ajax({
            type: "POST",
            url: "{{ path('horaire_prime', {'uid':user.uid, 'mois':mois, 'annee':annee}) }}",
            data: {prime: $(this).val()}
        });
    });


    $('.fictif').change(function () {
        $(this).val($(this).val().replace(',', '.'));
        $(this).parent().css('background-color', '#dce6ed');
        $.ajax({
            type: "POST",
            url: "{{ path('horaire_modif') }}",
            data: { 'id': $(this).attr('data-id'), 'heure':$(this).val() }
        });
        recalcul();
    });

    $('.fictif-without-id').change(function () {
        $(this).val($(this).val().replace(',', '.'));
        $(this).parent().css('background-color', '#dce6ed');
        $.ajax({
            type: "POST",
            url: "{{ path('horaire_modif_without_id') }}",
            data: { 'date': $(this).attr('data-date'), 'user': $(this).attr('data-user'), 'heure':$(this).val() }
        });
        recalcul();
    });
    
    $('#accordion').sortable({
    
        handle: '.panel-default',
        invertSwap: true,
        onEnd: function (evt) {
            if (window.JSON) {
                list = $("#accordion").sortable("toArray");
                var request = $.ajax({
                    url : '{{ path('horaire_order') }}',
                    data: {order: window.JSON.stringify(list) },
                    method: "POST",
                });
            }
        }
    });
});

{% endif %}
{% endblock %}

{% block javascript_script %}
    <!-- Nestable List -->
    {#<script src="{{ asset('vendor/nestable/jquery.nestable.js') }}"></script>#}
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-sortablejs@latest/jquery-sortable.js"></script>
{% endblock %}